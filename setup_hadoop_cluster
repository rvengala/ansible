## This is pre-requise to setup hadoop cluster through ansible
## Usefull Links
# https://blog.dbi-services.com/deploy-a-cloudera-cluster-with-terraform-and-ansible-in-azure-part-2/
# https://software.danielwatrous.com/install-and-configure-a-multi-node-hadoop-cluster-using-ansible/   ( Build CDH with Ansible)
# https://github.com/dwatrous/hadoop-multi-server-ansible (Git:Build CDH with Ansible)

# Template information
https://docs.cloudera.com/documentation/enterprise/6/6.3/topics/install_cluster_template.html

# Use full commands
ansible-galaxy install trustedanalytics.cdh-configuration
ansible all -m authorized_key -a key="{{ lookup('file', '~/.ssh/id_rsa.pub') }} user=$USER" --ask-pass -u $USER --become-user $USER
ansible all -m authorized_key -a key="{{ lookup('file', '~/.ssh/id_rsa.pub') }} user=root" --ask-pass -u root

cat all | grep -v "^#"
# Java
https://archive.cloudera.com/director/redhat/7/x86_64/director/2/RPMS/x86_64/oracle-j2sdk1.8-1.8.0+update121-1.x86_64.rpm
curl -L -b "oraclelicense=a" http://download.oracle.com/otn-pub/java/jce/8/jce_policy-8.zip -O


## Doubts
# What is vm.swappiness
# 

## Install Cloudera prerequisites with Ansible
1. build VM 
2. setup dns
3. disable Fw
4. A password-less ssh connection to root user with a unique private keys must be configured
5. SELinux disabled
6. IPv6 disabled
7. vm.swappiness kernel option must be set to a value less or equal to 10



#!/bin/bash
## Install Cloudera prerequisites with Ansible
# Password less setup
ssh-keygen -q -t rsa -N '' -f ~/.ssh/id_rsa
cat /root/.ssh/id_rsa.pub >> /root/.ssh/authorized_keys

# Disable FW
firewall-cmd --state
systemctl stop firewalld
systemctl disable firewalld
systemctl mask --now firewalld
firewall-cmd --state

# Disable SELinux
cp -p /etc/selinux/config /etc/selinux/config.orig
sed -i -e 's/enforcing/disabled/g' /etc/selinux/config

# Add swappiness
cp -p /etc/sysctl.conf /etc/sysctl.conf.orig
echo "#                                                                             " >> /etc/sysctl.conf
echo "# Hadoop Swapping reduces the job performance, you should have maximum data in-memory and tune your OS so that it will do memory swap only when there is situation like OOM " >> /etc/sysctl.conf
echo "vm.swappiness=0" >> /etc/sysctl.conf

# Reboot the machine
init 6 or reboot

#
copy jdk to cdh cluster 

# install on cdh cluster
sudo yum install mysql-devel gcc gcc-devel python-devel
sudo easy_install mysql-python


# Ansible work
git clone https://github.com/cloudera/cloudera-playbook.git
cd cloudera-playbook
add required information in hosts file [cdpcluster.infoftps.com]



# run playbook
ansible-playbook -i hosts site.yml --syntax-check
ansible-playbook -i hosts site.yml --check


#####  ERRORS/SOLUTIONS

1:
ERROR:
TASK [java : set_fact] ********************************************************************************
fatal: [cdpcluster.infoftps.com]: FAILED! => {"msg": "The task includes an option with an undefined variable. 
The error was: 'dict object' has no attribute 'stdout_lines'\n\n The error appears to have been 
in '/root/cloudera-playbook/roles/java/tasks/main.yml': line 58, column 3, but may\nbe elsewhere in the file depending 
on the exact syntax problem.\n\nThe offending line appears to be:\n\n\n- set_fact:\n  ^ here\n\nexception
type: <class 'ansible.errors.AnsibleUndefinedVariable'>\nexception: 'dict object' has no attribute 'stdout_lines'"}
        to retry, use: --limit @/root/cloudera-playbook/site.retry

PLAY RECAP ********************************************************************************************
cdpcluster.infoftps.com    : ok=10   changed=6    unreachable=0    failed=1

SOLUTION:



